Для конечного дискретного подмножества плоскости $M\subset \mathbb{R}^2$
естественным образом определяется диаметр:
\begin{equation*}
	\operatorname{diam} M = \max_{A,B\in M} |A-B|
	.
\end{equation*}

Солимоси~\cite{solymosi2003note} показал существование такой константы $c$,
что для любого $S\in\mathfrak{M}_n$ выполнено $\operatorname{diam} M \geq c n$.
Солимоси не привёл значения этой константы, однако из его доказательства можно вывести,
что эта константа равна $1/24$.

Мы сейчас дадим оригинальное доказательство, конструкция которого отличается от конструкции,
предложенной Солимоси, дающее большее значение константы $c$.

TODO: надо ли ссылаться на стаью в матзаметках и рассказывать про независимость тамошнего доказательства?

\begin{lemma}
	\label{lemma_points_on_line}
	Пусть $S\in\mathfrak{M}_n$ для некоторого $n \geqslant 3$,
	$\{M_1, M_2, M_3, M_4\} \subset S$, как минимум три из этих точек различны,
	$|M_1 - M_2| = |M_3 - M_4| = 1$.
	Тогда никакая прямая $m$ не содержит точки $M_1$, $M_2$, $M_3$ и $M_4$ одновременно.
\end{lemma}

\begin{proof}
	Предположим противное.
	Обозначим через $m_{12}$ и $m_{34}$ серединные перпендикуляры к отрезкам $M_1 M_2$ и $M_3 M_4$ соответственно.

	Пусть точка $M\in S$.
	Тогда либо $|M - M_1| - |M - M_2| = 0$ и $M\in m_{12}$, либо $\Bigl||M - M_1| - |M - M_2|\Bigr| = 1$ и $M\in m$,
	т.е. в любом случае $M\in m \cup m_{12}$.
	Аналогично $M\in m \cup m_{34}$.
	Следовательно, $M\in (m \cup m_{12}) \cap (m \cup m_{34}) = m \cup (m_{12} \cap m_{34}) = m$,
	т.к. $m_{12} \cap m_{34} = \varnothing$ (перпендикуляры к одной прямой, проведённые в разных точках, не пересекаются между собой).

	В силу произвольности выбора $M \in S$ получаем $S \subset m$, что противоречит $S\in\mathfrak{M}_n$.
\end{proof}

\begin{corollary}
	\label{corollary:max_points_on_line}
	Пусть $S\in\mathfrak{M}_n$, $\operatorname{diam} S = d$.
	Тогда ни на какой прямой не лежит более $(d+3)/2$ точек из $S$.
\end{corollary}

\begin{proof}
	Предположим противное.
	Очевидно, что на прямой $m$ может быть не более $d+1$ точек системы $S$.

	Пусть сначала $d$ чётно.
	Тогда из каждой пары соседних точек, кроме, быть может, одной пары,
	нужно выбросить хотя бы одну точку в силу леммы~\ref{lemma_points_on_line}.
	Итого мы выбросим не менее $d/2$ точек,
	останется не более $(d+2)/2$ точек.

	Пусть теперь $d$ нечётно.
	Тогда нужно выбросить не менее $(d-1)/2$ точек.
	Останется не более $(d+3)/2$ точек.
\end{proof}

\begin{definition}
	Будем говорить, что подмножество плоскости $S\subset\mathbb{R}^2$
	вписано в квадрат со стороной $d$, если
	можно построить такой квадрат $Q$ со стороной $d$,
	что каждая точка $S$ окажется либо внутри $Q$, либо на одной из его сторон.
\end{definition}

\begin{lemma}
	\label{lemma:square_container}
	Пусть $S\in\mathfrak{M}_n$, $\operatorname{diam} S = d$.
	Тогда $S$ можно вписать в квадрат со стороной $d$.
\end{lemma}

\begin{proof}
	Пусть $M_1, M_2 \in S$, $|M_1 - M_2| = d$,
	т.е. диаметр системы $S$ достигается на $M_1$  $M_2$.
	Введём прямоугольную декартову систему координат на плоскости таким образом, что
	$M_1 = (-d/2; 0)$, $M_2 = (d/2; 0)$.

	Тогда прочие точки $M_i \in S$ имеют координаты $M_i=(x_i, y_i)$.
	Очевидно, что для $i>2$ имеем $|x_i| < d/2$
	(иначе $|M_i - M_1| > d$ или $|M_i - M_2| > d$).
	Более того, $|y_i| < d$ (иначе $|M_i - M_1| > d$ или $|M_i - M_2| > d$).

	Пусть $y_+ = \max_{i} y_i$, $y_- = \min_{i} y_i$, $M_+=(x_+, y_+)$, $M_-=(x_-, y_-)$
	(если максимум досигается на нескольких точках, возьмём любые из них).
	Тогда
	\begin{multline}
		d \geq |M_+ M_-| = \sqrt{(x_+ - x_-)^2 + (y_+ - y_-)^2}
		\geq
		\\\geq
		\sqrt{(y_+ - y_-)^2} =
		y_+ - y_-
	\end{multline}
	Следовательно, $S$ можно вписать в квадрат со сторонами $x=\pm d/2$,
	$y=y_+$, $y=y_+ - d$.
\end{proof}

\begin{remark}
	Вероятно, улучшить оценку на сторону квадрата, сделав её меньше диаметра,
	невозможно: часто встречаются конструкции множеств $S\in\mathfrak{M}_n$, расположенных на окружности
	~\cite{anning1915discussions,harborth1993upper,piepmeyer1996maximum,kurz2008bounds,our-vvmsh-2018}.
\end{remark}

\begin{definition}
	Крестом точек $M_1$ и $M_2$ будем называть объединение прямой,
	проходящей через эти точки,
	и серединного перпендикуляра к отрезку $M_1 M_2$
	и обозначать $cr(M_1,M_2)$.
\end{definition}

\begin{proposition}
	\label{proposition:intervals_cross}
	Если интервалы $M_1 M_2$ и $M_3 M_4$ не пересекаются,
	$M_1 \neq M_2$, $M_3 \neq M_4$,
	то $cr(M_1,M_2) \cap cr(M_3,M_4)$~--- либо не более 4 точек, либо прямая.
\end{proposition}

\begin{proof}
	Пересечением $cr(M_1,M_2) \cap cr(M_3,M_4)$ может быть либо от 2 до 4 точек, либо прямая,
	либо, если эти кресты совпадают, их пересечение совпадает с каждым из этих крестов.
	Но $cr(M_1,M_2) \neq cr(M_3,M_4)$, потому что середины отрезков $M_1 M_2$ и $M_3 M_4$
	совпасть не могут, т.к. интервалы $M_1 M_2$ и $M_3 M_4$ не пересекаются по условию.
\end{proof}

\begin{lemma}
	\label{lemma_preliminary_size}
	Пусть $S$~--- система Эрдёша,
	$M_1, M_2, M_3, M_4 \in S$,
	$M_1 \neq M_2$, $M_3 \neq M_4$,
	интервалы $M_1 M_2$ и $M_3 M_4$ не пересекаются,
	$d = \operatorname{diam} S > 5$.
	Тогда $|S| \leq 4 \cdot |M_1 - M_2| \cdot |M_3 - M_4| + \frac{d-5}{2}$.
\end{lemma}

\begin{proof}
	Если $|(cr(M_1, M_2) \cap cr(M_3, M_4))| < \infty$,
	то (см. доказательство теоремы~\ref{thmErdos} или~\cite[часть 2, неравенство (1)]{solymosi2003note})
	$|S| \leq 4 \cdot |M_1 - M_2| \cdot |M_3 - M_4|$.
	Иначе (в силу утверждения~\ref{proposition:intervals_cross}) $cr(M_1, M_2) \cap cr(M_3, M_4) = m$,
	где $m$~--- прямая.
	В силу следствия~\ref{corollary:max_points_on_line} на этой прямой лежит не более $(d+3)/2$ точек;
	кроме того, из общего количества точек нужно вычесть 4,
	которые бы дали эти 2 креста в случае дискретного переcечения.
	Получаем верхнюю оценку
	\begin{multline}
		|S| \leq 4 \cdot |M_1 - M_2| \cdot |M_3 - M_4| - 4 + \frac{d+3}{2}
		=
		\\=
		4 \cdot |M_1 - M_2| \cdot |M_3 - M_4| + \frac{d-5}{2}
		.
	\end{multline}
\end{proof}

Определим теперь коэффициенты упаковки точек в квадрат $\varphi_k$.
Пусть
\begin{equation*}
	\Phi_k = \{ P \subset [0;1]^2 : |P|=k\}
	,
\end{equation*}
где $[0;1]^2$~--- замкнутый единичный квадрат на плоскости.
Тогда
\begin{equation*}
	\varphi_k = \max_{P \in \Phi_k} \min_{A,B \in P} |A - B|
	.
\end{equation*}
Иначе говоря, через $\varphi_k$ будем обозначать наибольшее число, такое,
что в единичном квадрате нельзя разместить $k$ точек так,
чтобы расстояние между любыми двумя точками было не менее $\varphi_k$.
Проблема отыскания $\varphi_k$ носит название проблемы упаковки точек в квадрат~\cite{locatelli2002packing,costa2013valid}.


\begin{lemma}
	Пусть $S$~--- система Эрдёша,
	$d = \operatorname{diam} S > 5$,
	$k \geq 2$,
	$m \geq 2$,
	$ |S| = (k-1)m^2 + 2$.

	Тогда
	\begin{equation}
		d \geq \mu (|S| - 2),
	\end{equation}
	где
	\begin{equation}
		\mu = \frac{\sqrt{64\varphi_k^2 (k-1)+1}-1}{16\varphi_k^2 (k-1)}
	\end{equation}
\end{lemma}

\begin{proof}
	Впишем $S$ в квадрат со стороной $d$ (см. лемму~\ref{lemma:square_container})
	и разобьём этот квадрат на $m^2$ маленьких квадратов со стороной $d/m$.
	Тогда по принципу Дирихле либо:

	а) хотя бы в два маленьких квадрата $Q_1$ и $Q_2$ попало не менее чем по $k$ точек;

	б) хотя бы в один маленький квадрат $Q_1$ попало не менее чем $k+1$ точка.
	\\
	В случае (а) в $Q_1$ выберем точки $M_1$ и $M_2$,
	а в $Q_2$ выберем точки $M_3$ и $M_4$
	так, что $|M_1 - M_2| \leq \varphi_k d /m$, $|M_3 - M_4| \leq \varphi_k d/m$
	(это всегда можно сделать в силу определения $\varphi_k$).

	В случае (б) в $Q_1$ выберем точки $M_1$ и $M_2$ так, что
	$|M_1 - M_2| \leq \varphi_{k+1} d /m \leq \varphi_k d /m$.
	Из всех точек, кроме $M_1$, выберем $M_3$ и $M_4$ так, что
	$|M_3 - M_4| \leq \varphi_k d/m$.
	Возможное совпадение $M_2$ и $M_3$ не помешает дальнейшему доказательству.

	TODO: реверанс про выпуклый четырёхугольник.

	По лемме~\ref{lemma_preliminary_size}
	\begin{equation}
		|S| \leq 4 \left( \frac{d}{m} \varphi_k \right)^2 + \frac{d}{2} - \frac{5}{2}
	\end{equation}
	или, с учётом того, что $ |S| = (k-1)m^2 + 2$,
	\begin{equation}
		 4 \left( \frac{d}{m} \varphi_k \right)^2 + \frac{d}{2} - \left( (k-1)m^2 + \frac{9}{2}\right) \geq 0
	\end{equation}

	Положим $d = \lambda m$:
	\begin{equation}
		 4 \lambda^2 \varphi_k^2 + \frac{m}{2} \lambda - \left( (k-1)m^2 + \frac{9}{2}\right) \geq 0
	\end{equation}

	Решим это квадратное неравенство относительно $\lambda$,
	зная, что $\lambda > 0$.

	Непосредственно выпишем дискриминант:
	\begin{multline}
		D =
		\frac{m^2}{4} + 4 \cdot 4 \varphi_k^2 \cdot \left( (k-1)m^2 + \frac{9}{2}\right)
		=
		\frac{m^2}{4} + 16 \varphi_k^2 \cdot \left( (k-1)m^2 + \frac{9}{2}\right)
		>\\>
		\frac{m^2}{4} + 16 \varphi_k^2 \cdot (k-1)m^2
		=
		\frac{m^2}{4} \cdot (1 + 64 \varphi_k^2 \cdot (k-1))
		> 0
	\end{multline}

	Итак,
	\begin{multline}
		\frac{d}{m} = \lambda >
		\frac{-\frac{m}{2} + \sqrt{\frac{m^2}{4} \cdot (1 + 64 \varphi_k^2 \cdot (k-1))} }{8 \varphi_k^2}
		=\\=
		\frac{-m + \sqrt{m^2  (1 + 64 \varphi_k^2 \cdot (k-1))} }{16 \varphi_k^2}
		=
		m\frac{ \sqrt{ 64 \varphi_k^2 (k-1) + 1} -1 }{16 \varphi_k^2}
	\end{multline}
	Разделим обе части неравенства на положительное число $m(k-1)$:
	\begin{equation}
		\frac{d}{(k-1)m^2}
		>
		\frac{ \sqrt{ 64 \varphi_k^2 (k-1) + 1} -1 }{16 \varphi_k^2 (k-1)}
	\end{equation}
	Положим
	\begin{equation}
		\mu = \frac{ \sqrt{ 64 \varphi_k^2 (k-1) + 1} -1 }{16 \varphi_k^2 (k-1)},
	\end{equation}
	тогда
	\begin{equation}
		\frac{d}{(k-1)m^2}
		>
		\mu
	\end{equation}
	откуда незамедлительно
	\begin{equation}
		d > \mu \cdot (|S|-2)
		.
	\end{equation}
\end{proof}


В~\cite{costa2013valid} приведены значения $\varphi_k$ до $k=10$ включительно

TODO: разобраться, насколько эти значения точны и откуда они взяты =/

По их расчётам получаем $\varphi_{10} = 0.4214$,
что даёт оценку $d>0.3583(|S|-2)$.

Это, конечно, для $|S|$ специального вида, но множитель $(m+1)^2 / m^2$ съестся на бесконечности,
а итоговые коэфициенты и так будем брать с запасом (кто их там знает, как они округляли).

Это для $|S| \geq 41$, но для меньших мощностей посчитано (и не один раз, в том числе нами).

Кстати, для $|S| = 3$ не проходит (и не должно).

А особенная приятность в том, что вычисление новых $\varphi_k$ может давать автоматическое улучшение оценки
(может, правда, и не давать).
Однако, как ни печально, константу не получится сделать даже 0.42 (есть нижняя оценка на $\varphi_k$).

Следующий прикол:
де-факто нам нужна не какая попало расстановка точек в единичном квадрате,
а расстановка с рациональными расстояниями (они потенциально могут превратиться в целые при умножении на $d/m$).
А возможность аппроксимировать произвольную расстановку расстановкой с рациональными расстояниями
уже имеет прямое отношение к проблеме Улама-Эрдёша (ссылка!!).
